import { Meta } from "@storybook/blocks";
import LinkTo from "@storybook/addon-links/react";

<Meta title="Modules/DynamicOverlays/Module" />

# Overview

This module extends the possibilities provided by the `OverlaysModule` from diagram-js. While this module already gives us the tooling to define overlays for each element, some more complex overlays might depend on the current root element, available elements and so on. Using this module overlays can be defined as builder functions that have access to additional information that are passed as <LinkTo kind="Modules/DynamicOverlays/OverlayBuilderEnvironment" story="docs">`OverlayBuilderEnvironment`</LinkTo>. This way, we try to reduce the neccessity to pass diagram instances around.

# Configuration

The `Dynamic Overlays Module` can be added to any `Diagram` instance via the `additionalModules` config property.

```tsx
import React, { useEffect } from "react";

import CoreModule from 'bpmn-js/lib/core';
import { useBaseViewer } from "bpmn-react/Viewer"
import { DynamicOverlaysModule } from "bpmn-react/Modules/DynamicOverlays"

const BaseViewer = ({ xml }) => {
    const [handleViewerRef, viewer] = useBaseViewer({ additionalModules: [ CoreModule, DynamicOverlaysModule ] });

    useEffect(() => {
        if (xml) {
            viewer?.importXML(xml);
        }
    }, [viewer, xml])

    return <div ref={ handleViewerRef } />
}
```

# Usage

When the `DynamicOverlaysModule` is configured properly, a service called `dynamicOverlays` is provided. It exposes all functions defined within the interface <LinkTo kind="Modules/DynamicOverlays/DynamicOverlayService" story="docs">DynamicOverlayService</LinkTo>. As alternative to accessing this service by name, you can also use the helper function <LinkTo kind="Modules/DynamicOverlays/getDynamicOverlays" story="docs">getDynamicOverlays</LinkTo>.

For the most common use case for registering a set of overlays to a diagram, we provide a custom React hook <LinkTo kind="Modules/DynamicOverlays/useDynamicOverlays" story="docs">useDynamicOverlays</LinkTo> which handles registering and unregistering on available life cycle hooks for both the component and the `Diagram`.

When it comes to defining dynamic overlays there are three supported types.

1. You will choose <LinkTo kind="Modules/DynamicOverlays/Types/OverlayDefinition" story="docs">OverlayDefinition</LinkTo> to define static overlays similar to the standard overlays, but prefer not to mix both ways.
2. You will choose <LinkTo kind="Modules/DynamicOverlays/Types/OverlayDefinitionBuilder" story="docs">OverlayDefinitionBuilder</LinkTo> to define an overlay per element that matches your filter. This is the default use case.
3. As last resort, when neither 1. nor 2. fulfill your requirement, there is <LinkTo kind="Modules/DynamicOverlays/Types/OverlayDefinitionsBuilder" story="docs">OverlayDefinitionsBuilder</LinkTo> to dynamically calculate a list of overlays with arbitrary length based on the elements that match your filter.

# Examples

## Simple Overlay Definition

```ts
const element = document.createElement();
element.innerText("This activity is very important!");

useDynamicOverlays(viewer, [{
  type: "",
  interactive: false,
  element: "Activity_12345",
  config: {
    position: {
        bottom: -5,
        right: -5,
    },
    html: element,
  },
}]);
```

## Simple Builder

```ts
useDynamicOverlays(viewer, [{
  elementFilter: (element: ElementLike) => is(element, "bpmn:userTask"),
  buildDefinition: (element: ElementLike) => {
    const htmlElement = document.createElement("div");
    htmlElement.style.width = `${element.width}px`;
    htmlElement.style.height = `${element.height}px`;
    htmlElement.title = element.id;

    return {
      interactive: true,
      element: element.id,
      config: {
        position: {
            bottom: -5,
            right: -5,
        },
        html: element,
      }
    }
  }
}]);
```

## Complex builder

```ts
useDynamicOverlays(viewer, [{
  elementFilter: (element: ElementLike) => true,
  buildDefinitions: (elements: ElementLike[], env: OverlayBuilderEnvironment) => {
    const htmlElement = document.createElement("div");
    htmlElement.innerText = `This model contains a total of ${elements.length} elements.`;

    return {
      interactive: false,
      element: env.rootElement().id,
      config: {
        position: {
            top: 0,
            left: 0,
        },
        html: htmlElement,
      }
    }
  }
}]);
```

More examples can be found in the <LinkTo kind="Overlays/Documentation" story="docs">Overlays</LinkTo> section.
